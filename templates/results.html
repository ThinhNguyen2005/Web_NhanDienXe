{% extends "base.html" %}

{% block title %}Kết quả phân tích - Traffic Violation Detection{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4><i class="fas fa-chart-line"></i> Kết quả phân tích video</h4>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-video fa-3x text-primary mb-2"></i>
                                <h6>Tổng số frame</h6>
                                <span class="badge bg-primary fs-6">{{ status.total_frames or 0 }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-2"></i>
                                <h6>Vi phạm phát hiện</h6>
                                <span class="badge bg-danger fs-6">{{ status.violations_found or 0 }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-download fa-3x text-success mb-2"></i>
                                <h6>Video đã xử lý</h6>
                                <a href="{{ url_for('download_processed_video', job_id=job_id) }}" 
                                   class="btn btn-success btn-sm">
                                    <i class="fas fa-download"></i> Tải xuống
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                {% if violations %}
                <h5><i class="fas fa-list"></i> Danh sách vi phạm ({{ violations|length }})</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-danger">
                            <tr>
                                <th>STT</th>
                                <th>Biển số xe</th>
                                <th>Thời gian</th>
                                <th>Frame</th>
                                <th>Độ tin cậy</th>
                                <th>Hình ảnh</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for violation in violations %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <strong class="text-danger">{{ violation.license_plate }}</strong>
                                </td>
                                <td>{{ violation.timestamp[:19].replace('T', ' ') }}</td>
                                <td>{{ violation.frame_number }}</td>
                                <td>
                                    <span class="badge bg-{% if violation.confidence > 0.8 %}success{% elif violation.confidence > 0.6 %}warning{% else %}danger{% endif %}">
                                        {{ "%.1f%%"|format(violation.confidence * 100) }}
                                    </span>
                                </td>
                                <td>
                                    <a href="{{ url_for('get_violation_image', job_id=job_id, violation_id=violation.id) }}" 
                                       target="_blank" class="btn btn-info btn-sm">
                                        <i class="fas fa-image"></i> Xem ảnh
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                    <h5>Không phát hiện vi phạm</h5>
                    <p>Không có xe nào vi phạm đèn đỏ trong video này.</p>
                </div>
                {% endif %}

                <div class="mt-4">
                    <h6><i class="fas fa-lightbulb"></i> Ghi chú:</h6>
                    <ul>
                        <li>Độ tin cậy cho biết mức độ chắc chắn của hệ thống khi nhận diện biển số</li>
                        <li>Click vào "Xem ảnh" để xem ảnh chụp thời điểm vi phạm</li>
                        <li>Tất cả thông tin vi phạm đã được lưu vào cơ sở dữ liệu</li>
                        <li>Bạn có thể tra cứu vi phạm theo biển số xe ở mục "Tra cứu vi phạm"</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="mt-3 text-center">
            <a href="{{ url_for('upload_video') }}" class="btn btn-primary me-2">
                <i class="fas fa-upload"></i> Phân tích video khác
            </a>
            <a href="{{ url_for('search_violations') }}" class="btn btn-secondary">
                <i class="fas fa-search"></i> Tra cứu vi phạm
            </a>
        </div>
    </div>
</div>
{% endblock %}