{% extends "base.html" %}

{% block title %}Kết quả phân tích - Traffic Violation Detection{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto shadow-lg p-3 rounded-4">
        <div class="">
            <div class="card-header bg-success text-white p-2 rounded-2">
                <h4><i class="fas fa-chart-line"></i> Kết quả phân tích video</h4>
            </div>
            <div class="card-body">
                <div class="row mb-4 justify-content-center p-3">
                    <!-- <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-video fa-3x text-primary mb-2"></i>
                                <h6>Tổng số frame</h6>
                                <span class="badge bg-primary fs-6">{{ status.total_frames or 0 }}</span>
                            </div>
                        </div>
                    </div> -->
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-2"></i>
                                <h6>Vi phạm phát hiện</h6>
                                <span class="badge bg-danger fs-6">{{ violations|length }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-download fa-3x text-success mb-2"></i>
                                <h6>Video đã xử lý</h6>
                                <a href="{{ url_for('download_processed_video', job_id=job_id) }}" 
                                   class="btn btn-success btn-sm">
                                    <i class="fas fa-download"></i> Tải xuống
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                {% if violations %}
                <h5><i class="fas fa-list"></i> Danh sách vi phạm ({{ violations|length }})</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-danger">
                            <tr>
                                <th>STT</th>
                                <th>Biển số xe</th>
                                <th>Thời gian</th>
                                <!-- <th>Frame</th>
                                <th>Độ tin cậy</th> -->
                                <th>Hình ảnh</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for violation in violations %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <strong class="text-danger">{{ violation.license_plate }}</strong>
                                </td>
                                <td>{{ violation.timestamp[:19].replace('T', ' ') }}</td>
                                <!-- <td>{{ violation.frame_number }}</td>
                                <td>
                                    <span class="badge bg-{% if violation.confidence > 0.8 %}success{% elif violation.confidence > 0.6 %}warning{% else %}danger{% endif %}">
                                        {{ "%.1f%%"|format(violation.confidence * 100) }}
                                    </span>
                                </td> -->
                                <td>
                                    <button class="btn btn-info btn-sm open-image"
                                            data-img="{{ url_for('get_violation_image', job_id=job_id, violation_id=violation.track_id or violation.id) }}"
                                            data-idx="{{ loop.index0 }}">
                                        <i class="fas fa-image"></i> Xem ảnh
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                    <h5>Không phát hiện vi phạm</h5>
                    <p>Không có xe nào vi phạm đèn đỏ trong video này.</p>
                </div>
                {% endif %}

                <div class="mt-4">
                    <h6><i class="fas fa-lightbulb"></i> Ghi chú:</h6>
                    <ul>
                        <li>Độ tin cậy cho biết mức độ chắc chắn của hệ thống khi nhận diện biển số</li>
                        <li>Click vào "Xem ảnh" để xem ảnh chụp thời điểm vi phạm</li>
                        <li>Tất cả thông tin vi phạm đã được lưu vào cơ sở dữ liệu</li>
                        <li>Bạn có thể tra cứu vi phạm theo biển số xe ở mục "Tra cứu vi phạm"</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Modal xem ảnh -->
        <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-image me-2"></i>Ảnh vi phạm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid rounded" alt="violation">
              </div>
              <div class="modal-footer justify-content-between">
                <button id="prevImg" type="button" class="btn btn-outline-secondary">
                  <i class="fas fa-chevron-left"></i> Trước
                </button>
                <a id="downloadImg" href="#" class="btn btn-outline-primary" download>
                  <i class="fas fa-download"></i> Tải ảnh
                </a>
                <button id="nextImg" type="button" class="btn btn-outline-secondary">
                  Sau <i class="fas fa-chevron-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-3 text-center">
            <a href="{{ url_for('upload_video') }}" class="btn btn-primary me-2">
                <i class="fas fa-upload"></i> Phân tích video khác
            </a>
            <a href="{{ url_for('search_violations') }}" class="btn btn-secondary">
                <i class="fas fa-search"></i> Tra cứu vi phạm
            </a>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  (function(){
    const imageUrls = Array.from(document.querySelectorAll('.open-image'))
      .map(btn => btn.getAttribute('data-img'));
    let currentIdx = 0;

    function show(idx){
      if (idx < 0 || idx >= imageUrls.length) return;
      currentIdx = idx;
      const url = imageUrls[currentIdx];
      const img = document.getElementById('modalImage');
      const a = document.getElementById('downloadImg');
      img.src = url;
      a.href = url;
      const modal = new bootstrap.Modal(document.getElementById('imageModal'));
      modal.show();
    }

    document.querySelectorAll('.open-image').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = parseInt(btn.getAttribute('data-idx')) || 0;
        show(idx);
      });
    });

    document.getElementById('prevImg').addEventListener('click', () => {
      show((currentIdx - 1 + imageUrls.length) % imageUrls.length);
    });
    document.getElementById('nextImg').addEventListener('click', () => {
      show((currentIdx + 1) % imageUrls.length);
    });
  })();
</script>
{% endblock %}